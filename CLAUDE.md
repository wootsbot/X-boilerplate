# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Development Commands

### Getting Started
- `pnpm dev` - Start development server (default port 3000)
- `pnpm build` - Build for production
- `pnpm start` - Start production server

### Testing
- `pnpm test` - Run unit tests with Vitest
- `pnpm test:ui` - Run tests with interactive UI
- `pnpm test:coverage` - Generate coverage report
- `pnpm test:e2e` - Run Playwright E2E tests (automatically starts dev server)
- `pnpm test:e2e:ui` - Run E2E tests with interactive UI
- `pnpm test:e2e:report` - View HTML report of last E2E test run

### Code Quality
- `pnpm lint` - Check code with Biome
- `pnpm lint:fix` - Fix linting issues with Biome
- `pnpm format` - Format code with Biome

### Database & Authentication
- `pnpm better-auth:generate` - Regenerate auth schema from better-auth config
- `pnpm drizzle:generate` - Generate migrations
- `pnpm drizzle:push` - Apply migrations to database
- `pnpm drizzle:migrate` - Run pending migrations

## Project Architecture

### Technology Stack
- **Framework**: Next.js 16 with React 19 using `/app` directory
- **Database**: Drizzle ORM with PostgreSQL adapter
- **Authentication**: better-auth with GitHub OAuth
- **State Management**: TanStack Query v5 (async), optional Zustand (client)
- **Forms**: react-hook-form with Zod validation
- **Server Actions**: next-safe-action for type-safe mutations
- **Styling**: Tailwind CSS 4 + Radix UI components (unstyled)
- **Email**: Resend + @react-email for transactional emails
- **Payments**: Stripe integration
- **Testing**: Vitest (unit), Playwright (E2E with Desktop Chrome & Mobile Chrome)
- **Code Quality**: Biome (linting/formatting), Husky (git hooks), commitlint

### Directory Structure

```
src/
├── app/              # Next.js app router
│  ├── (marketing)    # Public pages
│  ├── (features)     # Feature demo pages
│  ├── (public)       # Public auth pages
│  ├── @auth/         # Parallel route for auth modal
│  └── api/auth/      # better-auth API route
├── components/       # React components
│  ├── ui/            # Base UI components
│  ├── com/           # Composed reusable components
│  ├── auth/          # Auth-related components
│  ├── layout/        # Layout components
│  ├── resend/        # Email template components
│  └── query-v5/      # TanStack Query demos
├── lib/              # Core utilities & configurations
│  ├── auth/          # better-auth setup & client
│  ├── drizzle/       # Database client
│  ├── safe-action/   # Server action clients
│  ├── react-query/   # Query client provider
│  ├── payments/      # Stripe integration
│  ├── resend/        # Email service
│  ├── axios/         # HTTP client config
│  ├── logger.ts      # Logging utility
│  └── utils/         # Helper functions
├── state/            # Global state management
│  ├── queries/       # React Query hooks
│  │  └── github/     # GitHub search query with key factory
│  └── actions/       # Server actions (resend, stripe)
├── db/               # Database schema (Drizzle)
└── i18n/             # next-intl configuration
```

### Path Aliases
- `#/*` → `./src/*` (primary alias for all source code)
- `~/pkg` → `./package.json`

## Key Patterns & Implementation Details

### Server Actions with Middleware
The `src/lib/safe-action/index.ts` exports three action clients with progressive capability:

1. **`actionClient`**: Base client for public actions
2. **`authUserActionClient`**: Optional auth context with logging
   - Retrieves session via `auth.api.getSession({ headers })`
   - Provides `ctx.user` to action (null if not authenticated)
3. **`authRequiredActionClient`**: Enforces authentication
   - Throws `ActionError("Unauthorized")` if no session
   - Provides authenticated `ctx.user`

All clients log metadata, client input, and execution time in development.

### Query Management
- Uses `@lukemorales/query-key-factory` for type-safe, structured query keys
- Example: `src/state/queries/github/index.ts` demonstrates the pattern
- Query keys are defined in `const.ts`, schemas in `schema.ts`

### React Query Setup
The `ReactQueryClientProvider` in `src/app/provider.tsx` wraps the entire application. This is the root provider for TanStack Query.

### Authentication Flow
- better-auth handles OAuth flow with GitHub
- Session retrieved server-side via `auth.api.getSession({ headers })`
- Database adapter uses Drizzle with PostgreSQL provider
- Cookie prefix: `x-boilerplate`

### Database Integration
- Drizzle ORM with PostgreSQL
- Schema auto-generated by better-auth (in `src/db/schema.ts`)
- Regenerate schema after auth config changes with `pnpm better-auth:generate`

## Code Quality Standards

### Biome Configuration
Strict rules are enforced:
- **Formatting**: 120 character line width, 2-space indent
- **Linting**: 
  - No unused imports/variables
  - No console except error/warn/info/assert
  - No explicit `any` types (warn)
  - No nested ternaries
  - Exhaustive dependency arrays (warn)
  - Import type syntax enforced
  - No for-each loops (use map/filter)

### TypeScript
- Strict mode enabled
- Target: ES2017
- Incremental builds enabled

## Requirements
- Node.js 22+
- pnpm 10+
- PostgreSQL database for development
- GitHub OAuth credentials (GITHUB_CLIENT_ID, GITHUB_CLIENT_SECRET)

## Testing Notes

### Playwright E2E
- Configured for Desktop Chrome and Mobile Chrome
- Automatically starts `pnpm dev` when running tests
- Tests located in `e2e/` directory
- Results output to `e2e/results/`
- Uses baseURL from environment (default: `http://localhost:3000`)
- Retries enabled on CI (2 retries), disabled locally
- Parallel execution enabled locally, serial on CI

### Vitest Unit Tests
- Runs with jsdom environment
- Coverage enabled with @vitest/coverage-v8
